#!/usr/bin/env bash
# ===================================================
# PTERODACTYL HOSTING MANAGER - NEXT GEN ULTRA EDITION
# 2025 Edition
# ===================================================
# Discord : https://discord.gg/steamunlocker
# ===================================================
set -e
# Next-Gen Neon Color Theme
RESET="\e[0m"
BOLD="\e[1m"
DIM="\e[2m"
UNDERLINE="\e[4m"
CYAN="\e[96m"
BLUE="\e[94m"
PURPLE="\e[95m"
GREEN="\e[92m"
YELLOW="\e[93m"
RED="\e[91m"
WHITE="\e[97m"
NEON_GREEN="\e[38;5;82m"
NEON_PURPLE="\e[38;5;165m"
DANGER="\e[38;5;75m"
GLOW="\e[38;5;51m"
DANGER="\e[38;5;196m"
clear
# Epic Welcome Animation Header
welcome_banner() {
    clear

    echo -e "${NEON_PURPLE}${BOLD} NEXT GEN ULTRA EDITION - 2026${RESET}"
    echo -e "${GLOW} Ultimate Pterodactyl Control Center${RESET}"
    echo -e "${DIM} Discord: https://discord.gg/steamunlocker${RESET}"
    echo -e "${DANGER}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
    sleep 1.5
}
# Utility Functions
progress() { echo -e "${NEON_GREEN}${BOLD}â¤ $1${RESET}"; }
success() { echo -e "${GREEN}${BOLD}âœ“ $1${RESET}"; }
warning() { echo -e "${YELLOW}${BOLD}! $1${RESET}"; }
error() { echo -e "${RED}${BOLD}âœ˜ $1${RESET}"; }
print_box_header() {
    local text="$1"
    local color="${2:-$NEON_PURPLE}"
    echo -e "${color}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${color}${BOLD}â•‘${RESET} ${WHITE}${BOLD}$text$(printf '%*s' $((58 - ${#text})) '') ${color}${BOLD}â•‘${RESET}"
    echo -e "${color}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
}
print_menu_option() {
    local num="$1"
    local text="$2"
    echo -e "${DANGER} â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${RESET}"
    echo -e "${DANGER} â”‚${RESET} ${WHITE}${BOLD}[${NEON_GREEN}${num}${WHITE}]${RESET} ${CYAN}${text}$(printf '%*s' $((48 - ${#text} - 3)) '') ${DANGER}â”‚${RESET}"
    echo -e "${DANGER} â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}"
}
# Remote Script Runner
run_remote_script() {
    local url="$1"
    local name="$2"
    clear
    
    print_box_header "$name" $NEON_PURPLE
    progress "TÃ©lÃ©chargement et exÃ©cution du script distant..."
    local temp_script=$(mktemp)
    if curl -fsSL "$url" -o "$temp_script"; then
        chmod +x "$temp_script"
        bash "$temp_script"
        rm -f "$temp_script"
        success "$name terminÃ© !"
    else
        error "Ã‰chec du tÃ©lÃ©chargement du script depuis $url"
    fi
    echo -e "\n${DANGER}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    read -p $'\e[93mAppuyez sur EntrÃ©e pour revenir au menu...\e[0m' -r
}
# Main Menu
show_menu() {
    clear

    echo -e "${NEON_PURPLE}${BOLD} GESTIONNAIRE D'HÃ‰BERGEMENT PTERODACTYL${RESET}\n"
    print_box_header "PANNEAU DE COMMANDE" $NEON_PURPLE
    print_menu_option "1" "Installation du Panel"
    print_menu_option "2" "Installation des Wings"
    print_menu_option "3" "Mise Ã  jour du Panel"
    print_menu_option "4" "Outils de dÃ©sinstallation"
    print_menu_option "5" "Configuration de Blueprint"
    print_menu_option "6" "Configuration de Cloudflare"
    print_menu_option "7" "Changer de thÃ¨me"
    print_menu_option "8" "Tailscale (Installation + Mise en service)"
    print_menu_option "9" "Gestionnaire de joueurs Minecraft"
    print_menu_option "10" "Installation de Jexactyl"
    print_menu_option "0" "Sortir du gestionnaire"
    echo -e "\n${DANGER}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    read -p $'\e[93m\e[1m SÃ©lectionner une option [0-10] : \e[0m' choice
    echo
}
# Welcome
welcome_banner
# Main Loop
while true; do
    show_menu
    case $choice in
        1) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/panel2.sh" "PANEL INSTALLATION" ;;
        2) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/wing2.sh" "WINGS INSTALLATION" ;;
        3) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/update2.sh" "PANEL UPDATE" ;;
        4) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/uninstall2.sh" "UNINSTALL TOOLS" ;;
        5) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/Blueprint2.sh" "BLUEPRINT SETUP" ;;
        6) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/cloudflare.sh" "CLOUDFLARE SETUP" ;;
        7) run_remote_script "https://raw.githubusercontent.com/AlexxP624/Vps/refs/heads/main/cd/th2.sh" "THEME CHANGER" ;;
        8)
            clear
            print_box_header "INSTALLATION DE TAILSCALE" $NEON_PURPLE
            progress "Installation de Tailscale..."
            curl -fsSL https://tailscale.com/install.sh | sh
            success "Tailscale installÃ© !"
            systemctl enable --now tailscaled 2>/dev/null || true
            progress "Mise en ligne de Tailscale..."
            if [ -n "$TS_AUTH_KEY" ]; then
                sudo tailscale up -ssh --auth-key="$TS_AUTH_KEY" && success "AuthentifiÃ© via clÃ©"
            else
                sudo tailscale up -ssh && success "ConnectÃ© ! Approuver dans la console d'administration"
            fi
            read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
            ;;
9)
    clear
    print_box_header "GESTIONNAIRE DE JOUEURS MINECRAFT" $NEON_PURPLE
    progress "Installation des extensions Minecraft..."
    cd /var/www/pterodactyl || { error "RÃ©pertoire du Panel introuvable !"; read -p "Appuyez sur EntrÃ©e..."; continue; }
    
    wget -q https://github.com/AlexxP624/Vps/raw/main/minecraftplayermanager.blueprint
    wget -q https://github.com/AlexxP624/Vps/raw/main/mcplugins.blueprint
    wget -q https://github.com/AlexxP624/Vps/raw/main/huxregister.blueprint
    
    blueprint -i mcplugins.blueprint && success "Plugins MC installÃ©s"
    blueprint -i minecraftplayermanager.blueprint && success "Player Manager installÃ©"
    blueprint -i huxregister.blueprint && success "huxregister installÃ©"
    
    read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
    ;;
0)
            exit
            ;;
10)
            clear
            print_box_header "MIGRATION COMPLÃˆTE DU PANNEAU JEXACTYL" $NEON_PURPLE
            
            echo -e "${BOLD}${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
            echo -e "${BOLD}${RED}â•‘     	     	  AVERTISSEMENT CRITIQUE                     â•‘${RESET}"
            echo -e "${BOLD}${RED}â•‘  	Cela Ã‰CRASERA COMPLÃˆTEMENT votre panneau Pterodactyl     â•‘${RESET}"
            echo -e "${BOLD}${RED}â•‘  	     avec l'ensemble des fonctionnalitÃ©s Jexactyl 		 â•‘${RESET}"
	        echo -e "${BOLD}${RED}â•‘ 	           (facturation, billetterie, etc.).             â•‘${RESET}"	      
            echo -e "${BOLD}${RED}â•‘                                                              â•‘${RESET}"
            echo -e "${BOLD}${RED}â•‘         CETTE ACTION EST IRRÃ‰VERSIBLE SANS SAUVEGARDE !      â•‘${RESET}"
            echo -e "${BOLD}${RED}â•‘       SAUVEGARDEZ VOS FICHIERS ET VOTRE BASE DE DONNÃ‰ES      â•‘${RESET}"
            echo -e "${BOLD}${RED}â•‘                     AVANT DE CONTINUER !           			 â•‘${RESET}"
            echo -e "${BOLD}${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo
            
            # Require user to type exactly "yes" to confirm
            while true; do
                echo -e "${YELLOW}${BOLD}Pour poursuivre la migration, tapez ${UNDERLINE}yes${RESET}${YELLOW}${BOLD} exactement et appuyez sur EntrÃ©e :${RESET}"
                read -r confirmation
                if [[ "$confirmation" == "yes" ]]; then
                    break
                else
                    echo -e "${RED}${BOLD}âœ˜ Confirmation incorrecte. Vous avez saisi : '${confirmation:-<empty>}'${RESET}"
                    echo -e "${YELLOW}Migration annulÃ©e. Retour au menu...${RESET}"
                    read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                    continue 2  # Return to main menu
                fi
            done
            
            progress "Navigation vers le rÃ©pertoire des panneaux..."
            cd /var/www/pterodactyl || { 
                echo -e "${RED}${BOLD}âœ˜ RÃ©pertoire du panneau introuvable ! (/var/www/pterodactyl)${RESET}"
                read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                continue
            }
            
            progress "Mise en mode maintenance du panneau..."
            php artisan down || {
                echo -e "${RED}${BOLD}âœ˜ Ã‰chec de l'activation du mode maintenance.${RESET}"
                read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                continue
            }
            
            progress "TÃ©lÃ©chargement de la derniÃ¨re version stable de Jexactyl (v3.7.4)..."
            curl -L -o panel.tar.gz https://github.com/jexactyl/jexactyl/releases/download/v3.7.4/panel.tar.gz || {
                echo -e "${RED}${BOLD}âœ˜ Ã‰chec du tÃ©lÃ©chargement. VÃ©rifiez votre connexion Internet ou l'Ã©tat de GitHub.${RESET}"
                php artisan up
                read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                continue
            }
            
            progress "Extraction et remplacement des fichiers..."
            tar -xzvf panel.tar.gz >/dev/null && rm -f panel.tar.gz || {
                echo -e "${RED}${BOLD}âœ˜ Ã‰chec de l'extraction de l'archive.${RESET}"
                rm -f panel.tar.gz 2>/dev/null
                php artisan up
                read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                continue
            }
            
            progress "DÃ©finition des autorisations de stockage et de cache..."
            chmod -R 755 storage/* bootstrap/cache
            
            progress "Mise Ã  jour des dÃ©pendances Composer..."
            composer require asbiin/laravel-webauthn --no-interaction 2>/dev/null || echo -e "${YELLOW}â„¹ Paquet WebAuthn ignorÃ© (gÃ©nÃ©ralement inutile).${RESET}"
            composer install --no-dev --optimize-autoloader --no-interaction || {
                echo -e "${RED}${BOLD}âœ˜ Ã‰chec de l'installation du compositeur.${RESET}"
                php artisan up
                read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                continue
            }
            
            progress "Nettoyage des caches des applications..."
            php artisan optimize:clear
            
            progress "ExÃ©cution des migrations et du remplissage de la base de donnÃ©es..."
            php artisan migrate --seed --force || {
                echo -e "${RED}${BOLD}âœ˜ La migration de la base de donnÃ©es a Ã©chouÃ© ! Restaurez la sauvegarde dÃ¨s que possible !${RESET}"
                php artisan up
                read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
                continue
            }
            
            progress "Correction de la propriÃ©tÃ© du serveur web (www-data)..."
            chown -R www-data:www-data /var/www/pterodactyl/* 2>/dev/null || echo -e "${YELLOW}â„¹ Correction de propriÃ©tÃ© ignorÃ©e (chown manuel si nÃ©cessaire).${RESET}"
            
            progress "RedÃ©marrage des travailleurs de la file d'attente..."
            php artisan queue:restart
            
            progress "Remise en ligne du Panel..."
            php artisan up
            
            echo
            echo -e "${NEON_GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
            echo -e "${NEON_GREEN}${BOLD}â•‘                 MIGRATION DE JEXACTYL RÃ‰USSIE !                  â•‘${RESET}"
            echo -e "${NEON_GREEN}${BOLD}â•‘       Votre Panel fonctionne dÃ©sormais sous Jexactyl v3.7.4      â•‘${RESET}"
	        echo -e "${NEON_GREEN}${BOLD}â•‘                    (derniÃ¨re version stable).   				    â•‘${RESET}"
            echo -e "${NEON_GREEN}${BOLD}â•‘  Profitez de la facturation, de la billetterie, d'une interface  â•‘${RESET}"
            echo -e "${NEON_GREEN}${BOLD}â•‘  utilisateur amÃ©liorÃ©e et de nombreuses autres fonctionnalitÃ©s ! â•‘${RESET}"
            echo -e "${NEON_GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
            echo
            echo -e "${CYAN}${BOLD}âœ Actualisez le navigateur (Ctrl+Maj+R) pour charger le nouveau Panel.${RESET}"
            echo -e "${WHITE}${DIM}Bienvenue chez Jexactyl ! ğŸ‰${RESET}"
            
            read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
            ;;
    esac
done
