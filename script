#!/usr/bin/env bash

# ===================================================
#  CLOUD VM MANAGER - NEXT GEN ULTRA EDITION
#                     2025 Edition
# ===================================================
#  Discord : https://discord.gg/steamunlocker
# ===================================================

set -euo pipefail

# Next-Gen Neon Color Theme (Fixed & Optimized)
RESET="\033[0m"
BOLD="\033[1m"
DIM="\033[2m"
UNDERLINE="\033[4m"

CYAN="\033[96m"
BLUE="\033[94m"
PURPLE="\033[95m"
GREEN="\033[92m"
YELLOW="\033[93m"
RED="\033[91m"
WHITE="\033[97m"

NEON_GREEN="\033[38;5;82m"
NEON_PURPLE="\033[38;5;165m"
NEON_BLUE="\033[38;5;75m"
NEON_CYAN="\033[38;5;51m"
DANGER="\033[38;5;196m"

# Paths
VM_DIR="${VM_DIR:-$HOME/vms}"
mkdir -p "$VM_DIR"

# Supported OS Images (Now with Debian 11)
declare -A OS_OPTIONS=(
    ["Ubuntu 24.04 LTS"]="ubuntu|noble|https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img|ubuntu24|ubuntu|ubuntu"
    ["Ubuntu 22.04 LTS"]="ubuntu|jammy|https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img|ubuntu22|ubuntu|ubuntu"
    ["Debian 12 Bookworm"]="debian|bookworm|https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2|debian12|debian|debian"
    ["Debian 11 Bullseye"]="debian|bullseye|https://cloud.debian.org/images/cloud/bullseye/latest/debian-11-generic-amd64.qcow2|debian11|debian|debian"
    ["Debian 13 Trixie (Daily)"]="debian|trixie|https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-generic-amd64-daily.qcow2|debian13|debian|debian"
    ["AlmaLinux 9"]="almalinux|9|https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2|almalinux9|alma|alma"
    ["Rocky Linux 9"]="rockylinux|9|https://download.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-latest.x86_64.qcow2|rocky9|rocky|rocky"
)

# Masterpiece Header
display_header() {
    clear

    echo -e "${RESET}${NEON_PURPLE}${BOLD}            Ã‰DITION ULTRA NOUVELLE GÃ‰NÃ‰RATION â€¢ 2025${RESET}"
    echo -e "${NEON_CYAN}       AvancÃ© â€¢ SÃ©curisÃ© â€¢ Ultra-rapide VM dans le cloud${RESET}"
    echo -e "${NEON_BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
}

# Status Indicators
progress() { echo -e "${NEON_GREEN}${BOLD}âžœ $1${RESET}"; }
success() { echo -e "${GREEN}${BOLD}âœ“ $1${RESET}"; }
warning() { echo -e "${YELLOW}${BOLD}âš  $1${RESET}"; }
error() { echo -e "${RED}${BOLD}âœ— $1${RESET}"; }

# UI Elements
box_header() {
    local title="$1"
    echo -e "${NEON_PURPLE}${BOLD}"
    printf 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n'
    printf 'â•‘ %-58s â•‘\n' " $title "
    printf 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n'
    echo -e "${RESET}"
}

menu_item() {
    local num="$1"
    local text="$2"
    local status="${3:-}"
    printf "${NEON_BLUE}  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${RESET}\n"
    printf "${NEON_BLUE}  â”‚${RESET} ${WHITE}${BOLD}[${NEON_GREEN}%2s${WHITE}]${RESET} ${CYAN}%-40s${status} ${NEON_BLUE}â”‚${RESET}\n" "$num" "$text"
    printf "${NEON_BLUE}  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${RESET}\n"
}

# Dependency Check
check_dependencies() {
    local deps=("qemu-system-x86_64" "wget" "cloud-localds" "qemu-img" "lsof")
    local missing=()
    for dep in "${deps[@]}"; do
        command -v "$dep" &>/dev/null || missing+=("$dep")
    done
    if [ ${#missing[@]} -ne 0 ]; then
        error "DÃ©pendances manquantes : ${missing[*]}"
        warning "Installation : sudo apt install qemu-system cloud-image-utils wget lsof"
        exit 1
    fi
}

# Core Helpers
get_vm_list() { find "$VM_DIR" -name "*.conf" -exec basename {} .conf \; 2>/dev/null | sort; }

is_vm_running() {
    local vm_name="$1"
    pgrep -f "qemu-system.*$vm_name" >/dev/null && return 0
    load_vm_config "$vm_name" 2>/dev/null && [[ -n "${IMG_FILE:-}" ]] && pgrep -f "qemu-system.*${IMG_FILE}" >/dev/null && return 0
    return 1
}

load_vm_config() {
    local file="$VM_DIR/$1.conf"
    [[ -f "$file" ]] && source "$file" && return 0 || return 1
}

check_image_lock() {
    local img="$1" vm="$2"
    if lsof "$img" 2>/dev/null | grep -q qemu-system; then
        warning "Image utilisÃ©e par un autre processus"
        return 1
    fi
    local lock="${img}.lock"
    if [[ -f "$lock" ]] && ! find "$lock" -mmin +5 &>/dev/null; then
        return 1
    fi
    return 0
}

validate_input() {
    local type="$1" value="$2"
    case "$type" in
        number) [[ "$value" =~ ^[0-9]+$ ]] || return 1 ;;
        size) [[ "$value" =~ ^[0-9]+[GMgm]$ ]] || return 1 ;;
        port) [[ "$value" =~ ^[0-9]+$ ]] && ((23 <= value && value <= 65535)) || return 1 ;;
        name) [[ "$value" =~ ^[a-zA-Z0-9_-]+$ ]] || return 1 ;;
        username) [[ "$value" =~ ^[a-z_][a-z0-9_-]*$ ]] || return 1 ;;
    esac
    return 0
}

save_vm_config() {
    cat > "$VM_DIR/$VM_NAME.conf" <<EOF
VM_NAME="$VM_NAME"
OS_TYPE="$OS_TYPE"
CODENAME="$CODENAME"
IMG_URL="$IMG_URL"
HOSTNAME="$HOSTNAME"
USERNAME="$USERNAME"
PASSWORD="$PASSWORD"
DISK_SIZE="$DISK_SIZE"
MEMORY="$MEMORY"
CPUS="$CPUS"
SSH_PORT="$SSH_PORT"
GUI_MODE="$GUI_MODE"
PORT_FORWARDS="$PORT_FORWARDS"
IMG_FILE="$IMG_FILE"
SEED_FILE="$SEED_FILE"
CREATED="$(date)"
EOF
    success "Configuration enregistrÃ©e"
}

setup_vm_image() {
    progress "Configuration de l'image..."
    mkdir -p "$VM_DIR"

    if [[ ! -f "$IMG_FILE" ]]; then
        progress "TÃ©lÃ©chargement de l'image $OS_TYPE..."
        wget --progress=bar:force:noscroll "$IMG_URL" -O "$IMG_FILE"
    fi

    qemu-img resize "$IMG_FILE" "$DISK_SIZE" &>/dev/null || true

    cat > user-data <<EOF
#cloud-config
hostname: $HOSTNAME
ssh_pwauth: true
disable_root: false
users:
  - name: $USERNAME
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    passwd: $(openssl passwd -6 "$PASSWORD")
chpasswd:
  list: |
    root:$PASSWORD
    $USERNAME:$PASSWORD
  expire: false
EOF

    echo "instance-id: iid-$VM_NAME" > meta-data
    echo "local-hostname: $HOSTNAME" >> meta-data

    cloud-localds "$SEED_FILE" user-data meta-data
    success "PrÃªt pour le lancement"
}

create_new_vm() {
    display_header
    box_header "CRÃ‰ER UNE NOUVELLE MACHINE VIRTUELLE"

    local os_list=("${!OS_OPTIONS[@]}")
    local count=${#os_list[@]}
    for ((i=0; i<count; i++)); do
        echo -e " ${NEON_GREEN}$((i+1))${RESET} ${os_list[$i]}"
    done

    local choice
    while :; do
        printf "${CYAN}SÃ©lectionner le systÃ¨me d'exploitation [1-%s] : ${RESET}" "$count"
        read choice
        [[ "$choice" =~ ^[0-9]+$ ]] && ((1 <= choice && choice <= count)) && break
        error "Choix invalide"
    done

    local sel="${os_list[$((choice-1))]}"
    IFS='|' read -r OS_TYPE CODENAME IMG_URL DEF_HOST DEF_USER DEF_PASS <<< "${OS_OPTIONS[$sel]}"

    printf "${CYAN}Nom de la machine virtuelle [%s] : ${RESET}" "$DEF_HOST"
    read VM_NAME; VM_NAME=${VM_NAME:-$DEF_HOST}
    until validate_input name "$VM_NAME" && [[ ! -f "$VM_DIR/$VM_NAME.conf" ]]; do
        error "Invalide ou existe dÃ©jÃ "
        printf "${CYAN}Nom : ${RESET}"
        read VM_NAME
    done

    printf "${CYAN}Nom d'hÃ´te [%s] : ${RESET}" "$VM_NAME"
    read HOSTNAME; HOSTNAME=${HOSTNAME:-$VM_NAME}

    printf "${CYAN}Nom d'utilisateur [%s] : ${RESET}" "$DEF_USER"
    read USERNAME; USERNAME=${USERNAME:-$DEF_USER}

    printf "${CYAN}Mot de passe [auto] : ${RESET}"
    read -s PASSWORD; echo
    PASSWORD=${PASSWORD:-$DEF_PASS}

    printf "${CYAN}Disque [20G] : ${RESET}"
    read DISK_SIZE; DISK_SIZE=${DISK_SIZE:-20G}
    until validate_input size "$DISK_SIZE"; do
        printf "${CYAN}Disque : ${RESET}"
        read DISK_SIZE
    done

    printf "${CYAN}MÃ©moire vive (RAM) en Mo [2048]: ${RESET}"
    read MEMORY; MEMORY=${MEMORY:-2048}
    until validate_input number "$MEMORY"; do
        printf "${CYAN}MÃ©moire vive : ${RESET}"
        read MEMORY
    done

    printf "${CYAN}Processeurs [2] : ${RESET}"
    read CPUS; CPUS=${CPUS:-2}
    until validate_input number "$CPUS"; do
        printf "${CYAN}Processeurs : ${RESET}"
        read CPUS
    done

    printf "${CYAN}SSH Port [2222]: ${RESET}"
    read SSH_PORT; SSH_PORT=${SSH_PORT:-2222}
    until validate_input port "$SSH_PORT" && ! ss -tln | grep -q ":$SSH_PORT "; do
        error "Port invalide ou utilisÃ©"
        printf "${CYAN}Port : ${RESET}"
        read SSH_PORT
    done

    printf "${CYAN}GUI? (y/n) [n]: ${RESET}"
    read gui; GUI_MODE=false; [[ "$gui" =~ ^[Yy]$ ]] && GUI_MODE=true

    printf "${CYAN}Extra forwards: ${RESET}"
    read PORT_FORWARDS

    IMG_FILE="$VM_DIR/$VM_NAME.img"
    SEED_FILE="$VM_DIR/$VM_NAME-seed.iso"

    setup_vm_image
    save_vm_config
    success "VM '$VM_NAME' crÃ©Ã©e !"
    progress "Connexion : ssh -p $SSH_PORT $USERNAME@localhost"
}

start_vm() {
    local vm="$1"
    load_vm_config "$vm"

    check_image_lock "$IMG_FILE" "$vm" || { error "Image verrouillÃ©e"; return; }
    is_vm_running "$vm" && { warning "DÃ©jÃ  en cours d'exÃ©cution"; return; }

    local cmd=(
        qemu-system-x86_64 -enable-kvm -m "$MEMORY"M -smp "$CPUS" -cpu host
        -drive file="$IMG_FILE",format=qcow2,if=virtio,cache=writeback
        -drive file="$SEED_FILE",format=raw,if=virtio
        -boot order=c
        -device virtio-net-pci,netdev=n0
        -netdev user,id=n0,hostfwd=tcp::"$SSH_PORT"-:22
        -device virtio-balloon-pci
        -object rng-random,id=rng0,filename=/dev/urandom
        -device virtio-rng-pci,rng=rng0
    )

    if [[ -n "$PORT_FORWARDS" ]]; then
        IFS=',' read -ra fw <<< "$PORT_FORWARDS"
        local id=1
        for p in "${fw[@]}"; do
            IFS=':' read -r h g <<< "$p"
            cmd+=(-netdev user,id=n$id,hostfwd=tcp::"$h"-:"$g" -device virtio-net-pci,netdev=n$id)
            ((id++))
        done
    fi

    [[ "$GUI_MODE" == true ]] && cmd+=(-vga virtio -display gtk,gl=on) || cmd+=(-nographic)

    progress "Lancement $vm..."
    progress "SSH â†’ port $SSH_PORT"
    "${cmd[@]}"
    progress "VM terminÃ©e"
}

stop_vm() {
    local vm="$1"
    load_vm_config "$vm"
    is_vm_running "$vm" || { warning "Ne fonctionne pas"; return; }
    progress "ArrÃªt $vm..."
    pkill -f "qemu-system.*$IMG_FILE" || pkill -9 -f "qemu-system.*$IMG_FILE" || true
    rm -f "${IMG_FILE}.lock" 2>/dev/null
    success "ArrÃªtÃ©"
}

delete_vm() {
    local vm="$1"
    load_vm_config "$vm"
    warning "SUPPRESSION DÃ‰FINITIVE '$vm'?"
    read -p "Type YES: " c
    [[ "$c" == "YES" ]] || { progress "AnnulÃ©"; return; }
    is_vm_running "$vm" && stop_vm "$vm"
    rm -f "$IMG_FILE" "$SEED_FILE" "$VM_DIR/$vm.conf" "${IMG_FILE}.lock"
    success "SupprimÃ©"
}

show_vm_info() {
    local vm="$1"
    load_vm_config "$vm"
    box_header "INFORMATIONS : $vm"
    echo -e "${WHITE}SystÃ¨me d'exploitation :${RESET} $OS_TYPE $CODENAME"
    echo -e "${WHITE}HÃ´te :${RESET} $HOSTNAME â€¢ ${WHITE}User:${RESET} $USERNAME"
    echo -e "${WHITE}SSH :${RESET} ssh -p $SSH_PORT $USERNAME@localhost"
    echo -e "${WHITE}Ressources :${RESET} $MEMORY Mo MÃ©moire vive (RAM) â€¢ $CPUS Processeur â€¢ $DISK_SIZE Disque"
    echo -e "${WHITE}GUI :${RESET} $GUI_MODE â€¢ ${WHITE}Forwards :${RESET} ${PORT_FORWARDS:-None}"
    echo -e "${WHITE}Statut :${RESET} $(is_vm_running "$vm" && echo "ðŸŸ¢ En cours d'exÃ©cution" || echo "ðŸ”´ ArrÃªtÃ©")"
    read -p $'\e[93mAppuyez sur EntrÃ©e... \e[0m' -r
}

edit_vm_config() {
    local vm="$1"
    load_vm_config "$vm"
    while :; do
        box_header "EDIT: $vm"
        echo "1) Nom d'hÃ´te            [$HOSTNAME]"
        echo "2) Nom d'utilisateur     [$USERNAME]"
        echo "3) Mot de passe          [â€¢â€¢â€¢â€¢â€¢â€¢â€¢]"
        echo "4) SSH Port              [$SSH_PORT]"
        echo "5) GUI Mode              [$GUI_MODE]"
        echo "6) Forwards              [$PORT_FORWARDS]"
        echo "7) MÃ©moire vive          [$MEMORY MB]"
        echo "8) Processuers           [$CPUS]"
        echo "9) Disque                [$DISK_SIZE]"
        echo "0) Retour"
        read -p "Choix : " c
        case "$c" in
            1) printf "${CYAN}Nom d'hÃ´te : ${RESET}"; read HOSTNAME ;;
            2) printf "${CYAN}Nom d'utilisateur : ${RESET}"; read USERNAME ;;
            3) printf "${CYAN}Mot de passe : ${RESET}"; read -s PASSWORD; echo ;;
            4) printf "${CYAN}Port: ${RESET}"; read SSH_PORT ;;
            5) printf "${CYAN}GUI (y/n): ${RESET}"; read g; GUI_MODE=false; [[ "$g" =~ ^[Yy]$ ]] && GUI_MODE=true ;;
            6) printf "${CYAN}Forwards: ${RESET}"; read PORT_FORWARDS ;;
            7) printf "${CYAN}MÃ©moire vive (RAM) en Mo : ${RESET}"; read MEMORY ;;
            8) printf "${CYAN}Processeurs : ${RESET}"; read CPUS ;;
            9) printf "${CYAN}Disque : ${RESET}"; read DISK_SIZE ;;
            0) return ;;
        esac
        [[ "$c" =~ ^[1-3]$ ]] && setup_vm_image
        save_vm_config
    done
}

resize_vm_disk() {
    local vm="$1"
    load_vm_config "$vm"
    is_vm_running "$vm" && { error "ArrÃªter d'abord"; return; }
    printf "${CYAN}Nouvelle taille [%s] : ${RESET}" "$DISK_SIZE"
    read size; size=${size:-$DISK_SIZE}
    qemu-img resize "$IMG_FILE" "$size" && DISK_SIZE="$size" && save_vm_config && success "Resized to $size"
}

show_vm_performance() {
    local vm="$1"
    load_vm_config "$vm"
    box_header "PERFORMANCE : $vm"
    if is_vm_running "$vm"; then
        local pid=$(pgrep -f "qemu-system.*$IMG_FILE")
        [[ -n "$pid" ]] && ps -p "$pid" -o pid,%cpu,%mem,rss,vsz,cmd --no-headers
        free -h
        df -h "$(dirname "$IMG_FILE")"
    else
        warning "Ne fonctionne pas"
        echo "Configuration : $MEMORY Mo MÃ©moire vive â€¢ $CPUS Processeur â€¢ $DISK_SIZE Disque"
    fi
    read -p "Press Enter..."
}

fix_vm_issues() {
    local vm="$1"
    load_vm_config "$vm"
    box_header "CORRIGER : $vm"
    echo "1) Clear locks"
    echo "2) Rebuild seed"
    echo "3) Rebuild config"
    echo "4) Kill stuck QEMU"
    echo "0) Back"
    read -p "Choix : " c
    case "$c" in
        1) rm -f "${IMG_FILE}.lock"*; success "EffacÃ©" ;;
        2) rm -f "$SEED_FILE"; setup_vm_image ;;
        3) save_vm_config ;;
        4) pkill -9 -f "qemu-system.*$IMG_FILE" 2>/dev/null; success "Killed" ;;
        0) return ;;
    esac
}

# Main Loop
main_menu() {
    while :; do
        display_header

        local vms=($(get_vm_list))
        local n=${#vms[@]}

        if (( n > 0 )); then
            progress "Machines virtuelles ($n) :"
            for i in "${!vms[@]}"; do
                menu_item "$((i+1))" "${vms[$i]}" "$(is_vm_running "${vms[$i]}" && echo " ðŸŸ¢" || echo " ðŸ”´")"
            done
            echo
        fi

        box_header "CENTRE DE CONTRÃ”LE"

        menu_item "1" "CrÃ©er une nouvelle machine virtuelle"
        (( n > 0 )) && menu_item "2" "DÃ©marrer VM"
        (( n > 0 )) && menu_item "3" "ArrÃªter VM"
        (( n > 0 )) && menu_item "4" "Informations"
        (( n > 0 )) && menu_item "5" "Modifier"
        (( n > 0 )) && menu_item "6" "Supprimer"
        (( n > 0 )) && menu_item "7" "Redimensionner le disque"
        (( n > 0 )) && menu_item "8" "Performance"
        (( n > 0 )) && menu_item "9" "RÃ©soudre les problÃ¨mes"
        menu_item "0" "Sortir"

        printf "${NEON_CYAN}${BOLD}Choix : ${RESET}"
        read choice

        case "$choice" in
            1) create_new_vm ;;
            2|3|4|5|6|7|8|9)
                (( n == 0 )) && { warning "Pas VMs"; sleep 2; continue; }
                printf "${NEON_CYAN}NumÃ©ro VM : ${RESET}"
                read num
                [[ "$num" =~ ^[0-9]+$ ]] && (( 1 <= num && num <= n )) || { error "Non valide"; sleep 2; continue; }
                vm="${vms[$((num-1))]}"
                case "$choice" in
                    2) start_vm "$vm" ;;
                    3) stop_vm "$vm" ;;
                    4) show_vm_info "$vm" ;;
                    5) edit_vm_config "$vm" ;;
                    6) delete_vm "$vm" ;;
                    7) resize_vm_disk "$vm" ;;
                    8) show_vm_performance "$vm" ;;
                    9) fix_vm_issues "$vm" ;;
                esac
                ;;
            0)
                clear
             
                box_header "SESSION TERMINÃ‰E"
                echo -e "\n${WHITE}${BOLD}Gestionnaire de machines virtuelles cloud â€¢ ArrÃªtÃ©${RESET}"
                echo -e "${NEON_GREEN}${BOLD}Discord:${RESET} discord.gg/steamunlocker\n"
                exit 0
                ;;
            *) error "Choix invalide" ; sleep 2 ;;
        esac

        read -p $'\e[93mAppuyez sur EntrÃ©e pour continuer...\e[0m' -r
    done
}

# Cleanup & Start
trap 'rm -f user-data meta-data 2>/dev/null' EXIT
check_dependencies
main_menu
